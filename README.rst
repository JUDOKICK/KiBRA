===========================================
Kirale Border Router Administration (KiBRA)
===========================================

This project intends to be a reference implementation of a `Thread
<https://www.threadgroup.org/>`_ Border Router for a `GNU/Linux Debian
<https://www.debian.org/>`_ host and a `KiNOS <https://kinos.io/>`_ USB enabled
device.

It is written in Python 3.6, and provides a fast way for third-party developers
to test they Thread productsÂ´ site and global connectivity, or an starting
point for a commercial Border Router implementation.

Although it of course runs in single-board computers like `Raspberry Pi
<https://www.raspberrypi.org/>`_ or `Beage Board <https://beagleboard.org/>`_,
there is not even need to purchase any additional hardware apart from a
`KTDG102 USB Dongle <https://www.kirale.com/products/ktdg102/>`_ thanks to the
provided Virtual Machine Image Disk which can be run in any modern computer.

This project is licensed under the terms of the MIT license.

Features
========

- Autodetects an attached KiNOS device and uses it as Thread interface.
- Autodetects the exterior interface configuration (default route), but it is
  also possible to manually set the configuration.
- DHCPv6 server (`Dibbler <http://klub.com.pl/dhcpv6/>`_) autoconfiguration for
  DHCPv6-PD or ULA prefixes.
- NTP client and server, advertised to the Thread network in the DHCP options.
- Stateful NAT64 (`Jool <https://www.jool.mx/>`_) autoconfguration.
- mDNS (`Avahi <https://www.avahi.org/>`_) advertisement of MeshCoP Border
  Agent service in the exterior network, with support for external commissioner.
- Thread network real-time supervision with Thread Management Framework using a
  CoAP client (`aiocoap <https://www.avahi.org/>`_).
- Web based dynamic network visualization.
- Includes a tool to easyly form a big test Thread network with other attached
  KiNOS devices.

  .. image:: images/KiBRA-Web.png

Future improvements
===================

- ``systemd`` integration.
- DNS64 server functionality.
- `Port Control Protocol <https://datatracker.ietf.org/wg/pcp/documents/>`_
- Web based network configuration and commissioning.
- Multi-Thread interface support.

Requirements
============

The KiBRA application requires a `Python <https://python.org>` 3.5 installation
and makes use of several PyPi modules, apart from the `KiTools
<https://github.com/KiraleTechnologies/KiTools>`_ module. It has been tested in
Debian Buster and Raspbian Buster systems, but it will probably run correctly
in many other GNU/Linux distributions.

The required system packages are: ``avahi-daemon``, ``dibbler-server``,
``iproute2``, ``ip6tables``, ``jool`` and ``ntp``.

The required Python modules are: ``aiocoap``, ``bash``, ``kitools``,
``pycryptodomex`` and ``pyroute2``.

Installation
============

Install and configure system packages.
::

 apt install git python3 python3-pip avahi-daemon dibbler-server ntp
 echo "" > /etc/dibbler/server.conf

There is no official Debian package for Jool yet, so it needs to be compiled
from sources.
::

 cd
 apt install gcc make pkg-config libnl-genl-3-dev autoconf dkms linux-headers-$(uname -r) debhelper
 wget https://github.com/NICMx/releases/raw/master/Jool/Jool-3.5.6.zip
 unzip Jool-3.5.6.zip -d jool-3.5.6
 dkms install jool-3.5.6
 cd jool-3.5.6/usr
 bash autogen.sh && ./configure && make && make install
 cd && rm Jool-3.5.6.zip

Enable a virtual environment for the Python installation.
::

 pip3 install virtualenv
 python3 -m virtualenv -p /usr/bin/python3.6 py36env
 cd py36env
 source bin/activate

Download and install KiTools and KiBRA. The required Python modules will be
auto-installed.
::

 git clone https://github.com/KiraleTechnologies/KiTools.git
 python KiTools/setup.py install
 git clone https://github.com/KiraleTechnologies/KiBRA.git
 python KiBRA/setup.py install

Reduce the ammount of CoAP traffic generated by TMF subsystem
(https://github.com/chrysn/aiocoap/issues/75)
::

 sed -i 's/MAX_RETRANSMIT = 4/MAX_RETRANSMIT = 1/' ./lib/python3.6/site-packages/aiocoap/numbers/constants.py


Usage
=====

Plug a `KTW102 USB <https://www.kirale.com/products/ktdg102/>`_ dongle in and
run the installed script in the virtual environment:
::

 python -m kibra

If everything goes well, the script is going to detect the exterior interface
and the connected dongle, and configure the interfaces accordingly. If the
dongle USB Ethernet is not enabled, it is enabled by the script. By default,
the KiNOS device will perform an energy scan to select a proper IEEE 802.15.4
channel and start a Thread network partition on it as Leader.

Once the interior interface is up, the routing and firewall is configured and
the services launched: DHCP and NAT for the interior interface, and mDNS for
the exterior interface. Also the TMF subsystem starts to query the dongle for
network information. With this information, the network visualization can be
drawn. Open a browser on the exterior interface address to see it. Once modern
nodes are added to the network, the topology and link qualities will be
updated.

To stop the script, just type ``Ctrl+C`` and wait until all tasks have been
stopped.

Configuration file
------------------

The configuration file for the Kirale Border Router is located in
``/opt/kirale/kibra.cfg`` and has JSON format. If not provided, it is created
automatically at the first start with default values:
::

 {
   "dongle_name": "Test",
   "dongle_commcred": "KIRALE"
 }

The user can also force some other configuration options:
::

 {
   "dongle_channel": 20,
   "dongle_commcred": "KIRALE",
   "dongle_name": "MyDongle",
   "dongle_netname": "MyNetwork",
   "dongle_panid": "0xc04b",
   "dongle_role": "leader",
   "dongle_serial": "KTWM102-11+201707+8404D2000000045C"
   "exterior_ifname": "wlan0",
   "pool4": "10.92.0.0/16",
   "prefix": "2017:0:0:5::/64"
 }

Network formation
-----------------

The Kirale Border Router acts as a Border Agent for external commissioners. The
`Thread Commissioning App
<https://play.google.com/store/apps/details?id=org.threadgroup.commissioner>`_
can be installed in an Android device and connected to a Wi-Fi access point in
the same network as the Border Router.

If KiBRA was started correctly, the Commissioning App should be able to
discover the advertised network and ask for the Commissioner Credential in
order to access to its management. Once entered (by default: "KIRALE")it should
successfully join to the network and allow to scan a QR code.

    Tip: Use ``tcpdump`` for traffic overview on the interior interface.

Scan the QR code from another KTDG102 USB Dongle enclosure label and it will be
added to the Commissioner App entitled joiners list. The only configuration
required for the joiner is its desired role, and afterwards it can be booted in
the network.
::

 config role med
 ifup

The joiner should complete the commissioning with the Commissioning App and
appear in the network visualization. To check the correct border Router
functioning, enable the debug logs and send a ping request to an Inernet
address:
::

 debug module ipv6 icmp
 debug level all
 ping 64:ff9b::8.8.8.8

An ICMP echo response should arrive to the joined device.

Automatic network formation
---------------------------

The KiBRA application can be executed (from another terminal) with the
``--form`` option to read the currently running Border Router network
credentials and apply them to any plugged-in KTDG102 USB Dongles. Once
configured the devices join to the network in out-of-band mode, avoiding the
slow commissioning process.

This allows a fast network formation for different testing purposes.

The ``--clear`` option can be used to clear the configuration of all attached
KTDG102 USB Dongles, and therefore, remove them from the network.

Virtual Machine Kirale Border Router
====================================

TBD
